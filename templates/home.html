{% extends "htmlBase.html" %}
{% block titulo %}FastRoute - Dashboard{% endblock %}

{% block conteudo %}
<link href="{{ url_for('static', filename='css/dashboard.css') }}" rel="stylesheet">

<div class="container-fluid mt-0 px-3 px-md-4">

    <div class="row g-4">

        <!-- BLOCO 1 – Pedidos Importados COMPLETOS -->
        <div class="col-12 col-md-6 col-lg-6">
            <div class="card dashboard-card h-100 position-relative">

                <div class="position-absolute top-0 end-0 p-3">
                    <a href="{{ url_for('pedidos_importados') }}?filtro=completos&itens=100"
                    title="Ver pedidos completos">
                        <i class="bi bi-arrow-right-circle-fill seta-bloco"></i>
                    </a>
                </div>

                <div class="card-body d-flex flex-column align-items-center justify-content-center text-center">
                    <h5 class="titulo-bloco">Pedidos Aguardando Entregas</h5>
                    <p class="valor-bloco mb-1">{{ total_pedidos }}</p>
                    <small class="text-muted">Pedidos prontos para gerar rota (completos)</small>

                    <a href="{{ url_for('pedidos_importados') }}?filtro=completos&itens=100"
                    class="stretched-link"></a>
                </div>

            </div>
        </div>


        <!-- BLOCO 2 – Pedidos com Incompletos -->
        <div class="col-12 col-md-6 col-lg-6">
            <div class="card dashboard-card h-100 position-relative">

                <div class="position-absolute top-0 end-0 p-3">
                    <a href="{{ url_for('pedidos_importados') }}?filtro=incompletos&itens=100"
                    title="Ver pedidos incompletos">
                        <i class="bi bi-arrow-right-circle-fill seta-bloco text-danger"></i>
                    </a>
                </div>

                <div class="card-body d-flex flex-column align-items-center justify-content-center text-center">
                    <h5 class="titulo-bloco text-danger">Pedidos Incompletos</h5>
                    <p class="valor-bloco mb-1 text-danger">{{ pedidos_incompletos }}</p>
                    <small class="text-muted">Pedidos sem geolocalização (dados incompletos)</small>

                    <a href="{{ url_for('pedidos_importados') }}?filtro=incompletos&itens=100"
                    class="stretched-link"></a>
                </div>

            </div>
        </div>

    </div>

    <div class="row g-4 mt-1">

        <!-- BLOCO 3 – Entregas no Último Mês + Calendário -->
        <div class="col-12 col-lg-6">
            <div class="card dashboard-card h-100 position-relative">

                <div class="position-absolute top-0 end-0 p-3">
                    <a href="{{ url_for('pedidos_importados') }}?filtro=entregues&itens=100"
                    title="Ver pedidos Entregues">
                        <i class="bi bi-arrow-right-circle-fill seta-bloco"></i>
                    </a>
                </div>

                <div class="card-body text-center">
                    <h5 class="titulo-bloco">Entregas no Último Mês</h5>
                    <p class="valor-bloco mb-1">{{ entregas_ultimo_mes }}</p>
                    <small class="text-muted">Total de pedidos entregues no período (últimos 30 dias)</small>

                    <div class="calendario-wrapper mt-3">
                        <div id="miniCompactCalendario" class="mini-compact-calendar" aria-label="Calendário compacto"></div>
                    </div>

                </div>
            </div>
        </div>

        <!-- BLOCO 4 – Mini Mapa -->
        <div class="col-12 col-lg-6">
            <div class="card dashboard-card h-100 position-relative">

                <div class="card-body text-center position-relative">

                    <h5 class="titulo-bloco">Mapa de Entregas Pendentes</h5>
                    <small class="text-muted">Pedidos importados ainda não entregues</small>

                    <div id="miniMapa" class="mt-3 minimapa"></div>

                    <!-- BOTÃO PARA ABRIR O MAPA EXPANDIDO -->
                    <button id="abrirMapaExpandidoBtn"
                        class="btn-mapa-expandido position-absolute"
                        style="top: 12px; right: 20px; z-index: 50;"
                        title="Expandir mapa">
                        <i class="bi bi-arrows-fullscreen seta-bloco"></i>
                    </button>

                </div>

            </div>
        </div>

    </div>
</div>


<!-- OVERLAY DO MAPA EXPANDIDO -->
<div id="overlayMapa" class="overlay-mapa" style="display: none;">
    <div class="overlay-mapa-content">

        <button id="fecharOverlayMapa" class="btn-fechar-mapa">×</button>
        <h4 class="titulo-overlay">Mapa Completo de Entregas</h4>

        <!-- Botões de filtro estilo Leaflet -->
        <div class="filtro-mapa-bar">
            <button class="filtro-btn" id="filtroTodos">Todos</button>
            <button class="filtro-btn" id="filtroCompletos">Completos</button>
            <button class="filtro-btn" id="filtroEntregues">Entregues</button>
        </div>

        <div id="mapaExpandido"></div>
    </div>
</div>

<!-- Dependências locais (FullCalendar + Leaflet) -->
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script src="{{ url_for('static', filename='js/home_dashboard.js') }}"></script>

{% endblock %}
