{% extends "htmlBase.html" %}

{% block conteudo %}
<div class="container-fluid mt-4 px-3 px-md-4">
    <div class="row justify-content-center">
        <div class="col-12 col-xl-11 col-xxl-10">
            <div class="card shadow-lg border-0 rounded-4">
                <div class="card-body p-3 p-md-4 p-lg-5">
                    <h3 class="card-title mb-4 text-center" style="color: var(--verde-escuro);">Importar Arquivo CSV</h3>
                    
                    <form id="formImportacao" action="{{ url_for('processar_importacao') }}" method="POST" enctype="multipart/form-data">
                        <div class="mb-3">
                            <label for="arquivo" class="form-label">Selecione um arquivo CSV:</label>
                            <input type="file" class="form-control" id="arquivo" name="arquivo" accept=".csv" required>
                        </div>

                        <div class="text-center">
                            <div id="barraProgressoContainer" class="progress mb-3 d-none" style="height: 25px; background-color: #e9ecef; border-radius: 0.5rem;">
                                
                                <div id="barraProgresso"
                                     class="progress-bar progress-bar-striped progress-bar-animated"
                                     role="progressbar"
                                     style="
                                        width: 0%;
                                        background-color: #0c8f4e; 
                                        font-weight: bold;
                                        font-size: 0.9rem;
                                        transition: width 0.2s linear;
                                     "
                                     aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                                    Iniciando...
                                </div>

                            </div>

                            <button id="btnImportar" type="submit" class="btn btn-cotri px-4" style="background-color: #0c8f4e; color: white;">Importar</button>

                            {% if erro %}
                                <div class="alert alert-danger text-center mt-3">{{ erro }}</div>
                            {% endif %}
                            {% if sucesso %}
                                <div class="alert alert-success text-center mt-3">{{ sucesso }}</div>
                            {% endif %}
                        </div>
                    </form>

                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('formImportacao');
    const barraContainer = document.getElementById('barraProgressoContainer');
    const barra = document.getElementById('barraProgresso');
    const botao = document.getElementById('btnImportar');
    let intervalo;

    form.addEventListener('submit', function() {
        // Evita múltiplos cliques
        if(botao.disabled) return;
        
        botao.disabled = true;
        botao.innerHTML = 'Carregando...'; // Feedback visual no botão
        barraContainer.classList.remove('d-none');

        // Reset inicial
        let porcentagem = 0;
        barra.style.width = '0%';
        barra.textContent = 'Iniciando...';

        intervalo = setInterval(() => {
            // Lógica de "Desaceleração":
            // 1. Até 50%: Vai rápido (+5)
            // 2. De 50% a 80%: Vai médio (+2)
            // 3. De 80% a 99%: Vai muito devagar (+0.4), mas continua andando.
            
            let incremento = 0;

            if (porcentagem < 50) {
                incremento = 5;
            } else if (porcentagem < 80) {
                incremento = 2;
            } else if (porcentagem < 99) {
                incremento = 0.4; 
            } else {
                // Se chegou em 99%, para e espera o reload da página
                incremento = 0;
            }

            porcentagem += incremento;

            // Trava visual em 99%
            if (porcentagem > 99) porcentagem = 99;

            barra.style.width = porcentagem + '%';
            barra.setAttribute('aria-valuenow', porcentagem);

            // Atualiza o texto conforme o progresso
            if (porcentagem < 30) {
                 barra.textContent = 'Enviando arquivo...';
            } else if (porcentagem < 90) {
                 barra.textContent = 'Processando dados...';
            } else {
                 barra.textContent = 'Finalizando...';
            }

        }, 200); // Atualiza a cada 200ms para ficar fluido
    });
});
</script>

{% endblock %}