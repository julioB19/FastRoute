{% extends "htmlBase.html" %}
{% block titulo %}FastRoute - Rotas Otimizadas{% endblock %}

{% block conteudo %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<div class="container-fluid mt-3 px-3 px-md-4">
            <div class="row mb-3 no-print">
        <div class="col-12 d-flex justify-content-between align-items-center">
            <div>
                <h4 class="mb-1" style="color: rgb(237, 194, 0);">Rotas Otimizadas</h4>
                <small class="text-light">Resultados carregados do banco de dados</small>
            </div>
            <div class="d-flex gap-2">
                <a href="{{ url_for('pagina_otimizacao_rotas') }}" class="btn btn-cotri">
                    <i class="bi bi-lightning-charge"></i> Nova otimizacao
                </a>
                <button class="btn btn-outline-light" onclick="window.print()">
                    <i class="bi bi-printer"></i> Imprimir
                </button>
            </div>
        </div>
    </div>

    <div class="card shadow-sm mb-3">
        <div class="card-body">
            {% if mensagem_alerta %}
            <div class="alert alert-warning py-2 px-3 mb-3">
                {{ mensagem_alerta }}
            </div>
            {% endif %}
            <form id="filtrosRotas" method="get" class="row g-3 align-items-end no-print">
                <div class="col-md-3">
                    <label class="form-label text-dark">Filtrar por data da entrega</label>
                    <input id="filtroData" type="date" class="form-control" name="data" value="{{ data_filtro or '' }}">
                </div>
                <div class="col-md-3">
                    <label class="form-label text-dark">Filtrar por cliente</label>
                    <div class="input-group">
                        <input id="filtroCliente" type="text" class="form-control" name="cliente" value="{{ clientes_filtrados[0] if clientes_filtrados else '' }}" placeholder="Nome do cliente">
                        <button class="btn btn-cotri btn-lookup" type="button" data-tipo="cliente" title="Pesquisar cliente">
                            <i class="bi bi-search"></i>
                        </button>
                    </div>
                </div>
                <div class="col-md-3">
                    <label class="form-label text-dark">Filtrar por veiculo</label>
                    <div class="input-group">
                        <input id="filtroVeiculo" type="text" class="form-control" name="veiculo" value="{{ veiculos_filtrados[0] if veiculos_filtrados else '' }}" placeholder="Placa/veiculo">
                        <button class="btn btn-cotri btn-lookup" type="button" data-tipo="veiculo" title="Pesquisar veiculo">
                            <i class="bi bi-search"></i>
                        </button>
                    </div>
                </div>
                <div class="col-md-3 d-flex gap-2">
                    <button class="btn btn-cotri flex-fill" type="submit">Aplicar</button>
                    <a class="btn btn-outline-secondary flex-fill" href="{{ url_for('rotas_otimizadas') }}">Limpar</a>
                </div>
            </form>

        </div>
    </div>

    {% set resumo = relatorio_rotas or {} %}
    <div class="card shadow-sm mb-3 relatorio-card relatorio-print-only">
        <div class="card-header d-flex justify-content-between align-items-center flex-wrap gap-2">
            <div>
                <h5 class="mb-0 text-dark">Relatorio gerencial de rotas</h5>
                <small class="text-muted">Gerado em {{ resumo.data_emissao.strftime('%d/%m/%Y %H:%M') if resumo.data_emissao else '-' }}</small>
            </div>
        </div>
        <div class="card-body">
            <div class="row g-3 text-center">
                <div class="col-6 col-md-3">
                    <div class="resumo-box h-100">
                        <p class="resumo-label mb-1">Distancia estimada</p>
                        <h5 class="mb-1">{{ "%.1f"|format(resumo.distancia_total or 0) }} km</h5>
                        <small class="text-muted">Somatorio das rotas planejadas</small>
                    </div>
                </div>
                <div class="col-6 col-md-3">
                    <div class="resumo-box h-100">
                        <p class="resumo-label mb-1">Veiculos alocados</p>
                        <h5 class="mb-1">{{ resumo.total_veiculos or 0 }}</h5>
                        <small class="text-muted">Com pelo menos uma entrega</small>
                    </div>
                </div>
                <div class="col-6 col-md-3">
                    <div class="resumo-box h-100">
                        <p class="resumo-label mb-1">Paradas planejadas</p>
                        <h5 class="mb-1">{{ resumo.total_paradas or 0 }}</h5>
                        <small class="text-muted">Sequencias de descarga</small>
                    </div>
                </div>
                <div class="col-6 col-md-3">
                    <div class="resumo-box h-100">
                        <p class="resumo-label mb-1">Clientes atendidos</p>
                        <h5 class="mb-1">{{ resumo.total_clientes_unicos or 0 }}</h5>
                        <small class="text-muted">Pedidos considerados: {{ resumo.total_pedidos_considerados or 0 }}</small>
                    </div>
                </div>
            </div>

            <div class="table-responsive relatorio-print mt-4">
                <table class="table table-sm table-bordered mb-0 relatorio-print-table">
                    <thead class="table-light">
                        <tr>
                            <th>Veiculo</th>
                            <th class="text-center">Paradas</th>
                            <th>Sequencia planejada</th>
                            <th>Clientes atendidos</th>
                            <th>Observacoes</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if rotas_resumo %}
                            {% for rota in rotas_resumo %}
                            <tr>
                                <td>{{ rota.veiculo }}</td>
                                <td class="text-center fw-semibold">{{ rota.total_paradas }}</td>
                                <td>
                                    {% if rota.notas %}
                                        {{ rota.notas|join(" -> ") }}
                                    {% else %}
                                        Sem entregas
                                    {% endif %}
                                </td>
                                <td>
                                    {% if rota.clientes_legiveis %}
                                        {{ rota.clientes_legiveis|join(", ") }}
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                                <td class="small">
                                    {% if rota.primeira_entrega %}
                                        Primeira: {{ rota.primeira_entrega }} | Ultima: {{ rota.ultima_entrega }}
                                    {% else %}
                                        Sem paradas registradas.
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        {% else %}
                            <tr>
                                <td colspan="5" class="text-center text-muted">Nenhuma rota processada para este relatorio.</td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>

            <div class="row mt-3 g-3 relatorio-print">
                <div class="col-md-6">
                    <div class="d-flex flex-column h-100 gap-2 resumo-metricas">
                        <div class="resumo-chip">
                            <div class="chip-icon text-success"><i class="bi bi-geo-alt-fill"></i></div>
                            <div>
                                <div class="chip-label">Distancia total estimada</div>
                                <div class="chip-value">{{ "%.1f"|format(resumo.distancia_total or 0) }} km</div>
                            </div>
                        </div>
                        <div class="resumo-chip">
                            <div class="chip-icon text-primary"><i class="bi bi-people-fill"></i></div>
                            <div>
                                <div class="chip-label">Clientes atendidos</div>
                                <div class="chip-value">{{ resumo.total_clientes_unicos or 0 }} ({{ resumo.total_pedidos_considerados or 0 }} notas)</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="card shadow-sm no-print">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>Veiculo</th>
                            <th>Sequencia (Clientes)</th>
                            <th class="text-end">Resumo</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if rotas %}
                            {% for veic, seq in rotas.items() %}
                            {% set info = rotas_info_map.get(veic) %}
                            {% set veic_label = info.label if info else veic %}
                            <tr>
                                <td>{{ veic_label }}</td>
                                {% set clientes_seq = rotas_clientes.get(veic) %}
                                <td>
                                    {% if clientes_seq %}
                                        {{ clientes_seq|join(" -> ") }}
                                    {% else %}
                                        Sem entregas
                                    {% endif %}
                                </td>
                                <td class="text-end">
                                    <button class="btn btn-outline-secondary btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-{{ loop.index }}" aria-expanded="false">
                                        Detalhes
                                    </button>
                                </td>
                            </tr>
                            {% set rota_info = rotas_para_mapa_map.get(veic) %}
                            <tr class="collapse" id="collapse-{{ loop.index }}" data-veiculo="{{ veic }}" data-map-id="{{ rota_info.map_id if rota_info else '' }}">
                                <td colspan="3">
                                    <div class="p-3 bg-light rounded">
                                        <p class="mb-1 text-dark"><strong>Veiculo:</strong> {{ veic_label }}</p>
                                        {% if rota_info %}
                                            {% set clientes_seq = rotas_clientes.get(veic) %}
                                            <p class="mb-2 text-dark"><strong>Sequencia (clientes):</strong> {{ clientes_seq|join(" -> ") if clientes_seq else 'Sem entregas' }}</p>
                                            <div id="map-container-{{ loop.index }}" class="map-container">
                                                <div id="{{ rota_info.map_id }}" class="mapa-rota"></div>
                                            </div>
                                        {% else %}
                                            <p class="text-muted mb-0">Sem coordenadas para exibir o mapa.</p>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        {% else %}
                            <tr>
                                <td colspan="3" class="text-center py-4">Nenhum resultado encontrado. Execute uma otimizacao.</td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modal de lookup -->
<div class="modal fade" id="modalLookup" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered lookup-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="lookupTitulo">Pesquisar</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="text" class="form-control mb-2" id="lookupInput" placeholder="Digite para filtrar">
                <div id="lookupResultados" class="list-group" style="overflow-y: auto;"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>

<style>
.resumo-box {
    background: #f6f8fb;
    border: 1px solid #e5e7eb;
    border-radius: 10px;
    padding: 12px;
    text-align: left;
}

.resumo-label {
    font-size: 12px;
    letter-spacing: 0.02em;
    text-transform: uppercase;
    color: #6c757d;
}

.relatorio-card .badge {
    letter-spacing: 0.05em;
}

.relatorio-print-table td,
.relatorio-print-table th {
    font-size: 13px;
}

.relatorio-print-only {
    display: none;
}

.resumo-chip {
    display: flex;
    gap: 10px;
    align-items: center;
    border: 1px solid #e5e7eb;
    border-radius: 10px;
    padding: 10px 12px;
    background: #fff;
}

.chip-icon {
    font-size: 18px;
}

.chip-label {
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 0.04em;
    color: #6c757d;
}

.chip-value {
    font-weight: 700;
    color: #111;
}

.pendencias-card {
    border: 1px solid #f3d19c;
    background: #fff8ec;
    border-radius: 10px;
    padding: 12px;
}

.pendencia-badge {
    background: #f59e0b;
    color: #fff;
    padding: 4px 10px;
    border-radius: 8px;
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 0.04em;
}

.pendencia-item {
    display: flex;
    gap: 10px;
    align-items: flex-start;
    padding: 8px 0;
    border-top: 1px dashed #f3d19c;
}

.pendencia-item:first-of-type {
    border-top: none;
}

.pendencia-icon {
    font-size: 18px;
    width: 24px;
    text-align: center;
}

@media print {
    @page {
        margin: 8mm 10mm;
    }
    .no-print {
        display: none !important;
    }
    body {
        background: #fff;
        margin: 0;
    }
    .container-fluid {
        margin-top: 0 !important;
        padding-top: 0 !important;
    }
    .card {
        box-shadow: none !important;
    }
    .relatorio-print-only {
        display: block !important;
    }
    .relatorio-card {
        border: none;
        page-break-inside: avoid;
    }
    .relatorio-print table {
        page-break-inside: auto;
    }
    .relatorio-print table tr {
        page-break-inside: avoid;
    }
}

.lookup-modal {
    max-width: 520px;
    width: 520px;
}

#lookupResultados {
    max-height: 260px;
    min-height: 220px;
}

.map-container {
    width: 100%;
    height: 320px;
}

.mapa-rota {
    width: 100%;
    height: 100%;
    border-radius: 8px;
}
</style>

<script>
document.addEventListener("DOMContentLoaded", () => {
    const normalizarLista = (lista) => {
        if (!Array.isArray(lista)) return [];
        return lista.map((v) => (v === null || v === undefined ? "" : String(v)));
    };

    const dadosLookup = {
        cliente: normalizarLista({{ clientes_disponiveis|tojson }}),
        veiculo: normalizarLista({{ veiculos_disponiveis|tojson }}),
    };

    const campos = {
        cliente: document.getElementById("filtroCliente"),
        veiculo: document.getElementById("filtroVeiculo"),
    };

    const modalEl = document.getElementById("modalLookup");
    const modal = typeof bootstrap !== "undefined" ? new bootstrap.Modal(modalEl) : null;
    const lookupInput = document.getElementById("lookupInput");
    const lookupResultados = document.getElementById("lookupResultados");
    const lookupTitulo = document.getElementById("lookupTitulo");
    const filtrosForm = document.getElementById("filtrosRotas");
    let tipoAtual = null;
    let valoresAtuais = [];

    const renderResultados = (termo = "") => {
        lookupResultados.innerHTML = "";
        const filtro = (termo || "").toLowerCase();
        valoresAtuais
            .map((v) => String(v))
            .filter((v) => v.toLowerCase().includes(filtro))
            .slice(0, 100)
            .forEach((v) => {
                const item = document.createElement("button");
                item.type = "button";
                item.className = "list-group-item list-group-item-action";
                item.textContent = v;
                item.onclick = () => {
                    if (tipoAtual && campos[tipoAtual]) {
                        campos[tipoAtual].value = v;
                    }
                    if (modal) modal.hide();
                    if (filtrosForm) filtrosForm.submit();
                };
                lookupResultados.appendChild(item);
            });
        if (!lookupResultados.children.length) {
            const vazio = document.createElement("div");
            vazio.className = "list-group-item text-muted";
            vazio.textContent = "Nenhum resultado";
            lookupResultados.appendChild(vazio);
        }
    };

    document.querySelectorAll(".btn-lookup").forEach((btn) => {
        btn.addEventListener("click", () => {
            tipoAtual = btn.dataset.tipo;
            valoresAtuais = dadosLookup[tipoAtual] || [];
            lookupTitulo.textContent = `Pesquisar ${tipoAtual}`;
            lookupInput.value = campos[tipoAtual]?.value || "";
            renderResultados(lookupInput.value);
            if (modal) {
                modal.show();
                setTimeout(() => lookupInput.focus(), 150);
            }
        });
    });

    lookupInput.addEventListener("input", (e) => {
        renderResultados(e.target.value);
    });

    // Leaflet maps para rotas
    const rotasMapa = {{ rotas_para_mapa_map|tojson }};
    const rotasClientes = {{ rotas_clientes|tojson }};
    const mapas = {};
    const rotasOsrm = {};

    // Desenha rota real em estrada usando OSRM (OpenStreetMap)
    const desenharRotaReal = (map, rota) => {
        const coords = Array.isArray(rota?.rota) ? rota.rota : [];
        if (coords.length < 2) return null;

        const coordsOsrm = coords.map((c) => `${c[1]},${c[0]}`).join(";");
        const url = `https://router.project-osrm.org/route/v1/driving/${coordsOsrm}?overview=full&geometries=geojson&steps=false&continue_straight=true`;

        return fetch(url)
            .then((res) => res.json())
            .then((data) => {
                if (!data || data.code !== "Ok" || !data.routes || !data.routes.length) {
                    throw new Error("OSRM sem rota");
                }
                const linha = L.geoJSON(data.routes[0].geometry, {
                    style: { color: "#1b6a3f", weight: 5, opacity: 0.9 },
                }).addTo(map);
                map.fitBounds(linha.getBounds(), { padding: [20, 20] });
                return linha;
            })
            .catch(() => {
                // fallback: desenha linha direta se OSRM falhar
                const poly = L.polyline(coords, { color: "#1b6a3f", weight: 4, opacity: 0.85 }).addTo(map);
                map.fitBounds(poly.getBounds(), { padding: [20, 20] });
                return poly;
            });
    };

    const initMap = (rota, veiculo) => {
        if (!rota || !rota.map_id) {
            return;
        }
        const container = document.getElementById(rota.map_id);
        if (!container || mapas[rota.map_id]) {
            return;
        }
        const map = L.map(rota.map_id, { zoomControl: true });
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '&copy; OpenStreetMap'
        }).addTo(map);

        // Marcadores numerados na ordem da rota
        const clientesSeq = rotasClientes[veiculo] || [];
        const notasSeq = Array.isArray(rota.notas) ? rota.notas : [];

        (rota.pontos || []).forEach((p) => {
            const icon = L.divIcon({
                html: `<div class="marker-num">${p.label}</div>`,
                className: "marker-num-wrapper"
            });
            const marker = L.marker([p.lat, p.lng], { icon }).addTo(map);

            const posicao = Number(p.label);
            let tooltipTitle = "";
            if (posicao === 0) {
                tooltipTitle = "Deposito (saida/retorno)";
            } else {
                const idxEntrega = posicao - 1;
                const nomeCliente = clientesSeq[idxEntrega] || "Cliente nao informado";
                const entregaId = notasSeq[idxEntrega] || "Entrega";
                tooltipTitle = `${nomeCliente}<br>Entrega: ${entregaId}`;
            }
            marker.bindTooltip(tooltipTitle, { direction: "top", sticky: true });
        });

        // Rota em estrada (OSRM) respeitando a ordem recebida
        rotasOsrm[rota.map_id] = desenharRotaReal(map, rota);

        mapas[rota.map_id] = map;
    };

    const markerStyle = document.createElement("style");
    markerStyle.textContent = `
        .marker-num-wrapper {
            background: transparent;
            border: none;
        }
        .marker-num {
            background: #1b6a3f;
            color: #fff;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: grid;
            place-items: center;
            font-size: 14px;
            font-weight: 700;
            border: 2px solid #fff;
            box-shadow: 0 2px 6px rgba(0,0,0,0.25);
        }
    `;
    document.head.appendChild(markerStyle);

    document.querySelectorAll('[id^="collapse-"]').forEach((elem) => {
        elem.addEventListener('shown.bs.collapse', () => {
            const veic = elem.getAttribute("data-veiculo");
            const rota = veic ? rotasMapa[veic] : null;
            initMap(rota, veic);
            if (rota?.map_id && mapas[rota.map_id]) {
                setTimeout(() => mapas[rota.map_id].invalidateSize(), 150);
            }
        });
    });
});
</script>
{% endblock %}
