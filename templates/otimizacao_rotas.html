{% extends "htmlBase.html" %}
{% block titulo %}FastRoute - Otimização de Rotas{% endblock %}

{% block conteudo %}
<div class="container-fluid mt-3 px-3 px-md-4">
    <div class="row mb-3">
        <div class="col-12 d-flex justify-content-between align-items-center">
            <div>
                <h4 class="mb-1" style="color: rgb(237, 194, 0);">Otimização de Rotas</h4>
                <small class="text-light">Depósito padrão: {{ deposito_coord[0] }}, {{ deposito_coord[1] }}</small>
            </div>
            <button id="btnOtimizarRotas" class="btn btn-success">
                <i class="bi bi-lightning-charge"></i> Otimizar Selecionados
            </button>
        </div>
    </div>

    <div class="card shadow-sm mb-3">
        <div class="card-body">
            <form method="get" action="{{ url_for('pagina_otimizacao_rotas') }}" class="row g-3">
                <div class="col-md-4">
                    <label class="form-label text-dark">Cliente</label>
                    <select name="cliente_id" class="form-select">
                        <option value="">Todos</option>
                        {% for c in clientes %}
                        <option value="{{ c.id }}" {% if cliente_id and c.id == cliente_id %}selected{% endif %}>{{ c.nome }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label text-dark">Quantidade de pedidos (limite)</label>
                    <input type="number" name="limite" class="form-control" min="1" max="500" value="{{ limite or 50 }}">
                </div>
                <div class="col-md-3 d-flex align-items-end">
                    <button class="btn btn-cotri" type="submit">Aplicar filtros</button>
                    <a class="btn btn-outline-secondary ms-2" href="{{ url_for('pagina_otimizacao_rotas') }}">Limpar</a>
                </div>
            </form>
        </div>
    </div>

    <div class="card shadow-sm">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th style="width: 50px;">#</th>
                            <th>Nº da Nota</th>
                            <th>Cliente</th>
                            <th>Endereço</th>
                            <th>Data</th>
                            <th>Coordenadas</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if pedidos %}
                            {% for p in pedidos %}
                            <tr data-pedido-id="{{ p.id }}" data-coords="{{ p._orig.coordenadas }}">
                                <td>
                                    <input type="checkbox" class="form-check-input selecionar-pedido" checked>
                                </td>
                                <td>{{ p.numero_pedido }}</td>
                                <td>{{ p.cliente }}</td>
                                <td>{{ p.endereco }}</td>
                                <td>{{ p.data_nota | data_br }}</td>
                                <td>{{ p._orig.coordenadas }}</td>
                            </tr>
                            {% endfor %}
                        {% else %}
                            <tr>
                                <td colspan="6" class="text-center py-4">Nenhum pedido completo encontrado.</td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div id="barraProgressoContainer" class="gauge-overlay d-none">
    <div class="gauge-box">
        <p class="mb-2 fw-semibold text-center text-dark">Calculando rotas...</p>
        <div class="progress" style="height: 22px; background-color: #e9ecef; border-radius: 0.5rem;">
            <div id="barraProgresso"
                 class="progress-bar progress-bar-striped progress-bar-animated"
                 role="progressbar"
                 style="width: 0%; background-color: #0c8f4e; font-weight: 600; font-size: 0.9rem; transition: width 0.2s linear;"
                 aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                Iniciando...
            </div>
        </div>
    </div>
</div>

<style>
.gauge-overlay {
    position: fixed;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(0, 0, 0, 0.45);
    z-index: 2000;
    padding: 20px;
}

.gauge-box {
    background: #ffffff;
    border-radius: 12px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.25);
    padding: 18px 20px;
    min-width: 320px;
    max-width: 420px;
}
</style>

<script>
document.addEventListener("DOMContentLoaded", () => {
    const btn = document.getElementById("btnOtimizarRotas");
    const deposito = { lat: {{ deposito_coord[0] }}, lng: {{ deposito_coord[1] }} };
    const barraContainer = document.getElementById("barraProgressoContainer");
    const barra = document.getElementById("barraProgresso");
    let intervalo;

    const iniciarGauge = () => {
        if (!barraContainer || !barra) return;
        clearInterval(intervalo);
        barraContainer.classList.remove("d-none");
        let porcentagem = 0;
        barra.style.width = "0%";
        barra.textContent = "Iniciando...";
        intervalo = setInterval(() => {
            let inc = 0;
            if (porcentagem < 50) inc = 5;
            else if (porcentagem < 80) inc = 2;
            else if (porcentagem < 99) inc = 0.5;
            porcentagem = Math.min(99, porcentagem + inc);
            barra.style.width = `${porcentagem}%`;
            barra.setAttribute("aria-valuenow", porcentagem);
            if (porcentagem < 30) barra.textContent = "Coletando pedidos...";
            else if (porcentagem < 80) barra.textContent = "Calculando rotas...";
            else barra.textContent = "Finalizando...";
        }, 180);
    };

    const finalizarGauge = () => {
        if (!barraContainer || !barra) return;
        clearInterval(intervalo);
        barra.style.width = "100%";
        barra.textContent = "Concluido";
        setTimeout(() => barraContainer.classList.add("d-none"), 800);
    };

    const falhaGauge = () => {
        if (!barraContainer || !barra) return;
        clearInterval(intervalo);
        barra.style.width = "100%";
        barra.textContent = "Erro";
        setTimeout(() => barraContainer.classList.add("d-none"), 1200);
    };

    const salvarRotas = async () => {
        try {
            const respSalvar = await fetch("/salvar_rotas_otimizadas", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
            });
            const corpoSalvar = await respSalvar.json().catch(() => ({}));
            if (!respSalvar.ok || corpoSalvar?.erro) {
                throw new Error(corpoSalvar?.erro || "Nao foi possivel salvar as rotas.");
            }
            return true;
        } catch (err) {
            console.error(err);
            Swal.fire('Erro', err.message || 'Falha ao salvar rotas.', 'error');
            return false;
        }
    };

    const descartarOtimizacao = async () => {
        try {
            const resp = await fetch("/descartar_otimizacao", { method: "POST" });
            const body = await resp.json().catch(() => ({}));
            if (!resp.ok || body?.erro) {
                throw new Error(body?.erro || "Falha ao registrar recusa.");
            }
        } catch (err) {
            console.error("Falha ao descartar otimizacao:", err);
            Swal.fire('Erro', err.message || 'Falha ao recusar a rota.', 'error');
            throw err;
        }
    };

    btn.addEventListener("click", async () => {
        const selecionados = Array.from(document.querySelectorAll("tr[data-pedido-id]"))
            .filter((tr) => tr.querySelector(".selecionar-pedido")?.checked)
            .filter((tr) => (tr.dataset.coords || "").trim() !== "")
            .map((tr) => parseInt(tr.dataset.pedidoId, 10))
            .filter((id) => Number.isFinite(id));

        if (!selecionados.length) {
            Swal.fire('Atencao', 'Selecione ao menos um pedido com coordenadas.', 'warning');
            return;
        }

        const textoOriginal = btn.innerText;
        btn.disabled = true;
        btn.innerText = "Otimizando...";

        try {
            iniciarGauge();
            const resp = await fetch("/otimizar_rotas", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    pedido_ids: selecionados,
                    deposito: deposito,
                }),
            });
            const resultado = await resp.json();

            if (!resp.ok) {
                falhaGauge();
                Swal.fire('Erro', resultado.erro || 'Erro ao otimizar rotas.', 'error');
                return;
            }
            finalizarGauge();

            const clientesPorPedido = resultado.clientes_por_pedido || {};
            const rotas = resultado.rotas_por_veiculo || {};
            const formatSeq = (entregas) => {
                const seq = Array.isArray(entregas) ? entregas : [];
                const legivel = seq.map((n) => {
                    const base = String(n).split("#")[0];
                    return clientesPorPedido[base] || base;
                });
                return legivel.length ? legivel.join(" -> ") : "Sem entregas";
            };
            const resumoRotas = Object.entries(rotas)
                .map(([veiculo, entregas]) => `${veiculo}: ${formatSeq(entregas)}`)
                .join("<br>");
            const distancia = resultado.distancia_total_km
                ? Number.parseFloat(resultado.distancia_total_km).toFixed(2)
                : "0.00";

            Swal.fire({
                title: 'Otimizacao concluida!',
                html: `
                    <p style="margin-bottom:6px;"><strong>Distancia total estimada:</strong> ${distancia} km</p>
                    <p style="margin-bottom:6px;"><strong>Rotas criadas:</strong><br><span style="white-space:pre-wrap;text-align:left;display:block;">${resumoRotas}</span></p>
                    <p style="margin:0;">Clique em "Salvar rotas" para registrar as entregas ou recuse para descartar.</p>
                `,
                icon: 'success',
                showCancelButton: true,
                confirmButtonText: 'Salvar rotas',
                cancelButtonText: 'Recusar rota',
            }).then(async (result) => {
                if (result.isConfirmed) {
                    const salvou = await salvarRotas();
                    if (salvou) {
                        Swal.fire('Rotas salvas', 'As rotas foram registradas com sucesso.', 'success')
                            .then(() => {
                                window.location.href = "/rotas_otimizadas?origem=sessao";
                            });
                    }
                } else if (result.isDismissed) {
                    try {
                        await descartarOtimizacao();
                        Swal.fire('Rota recusada', 'Nenhuma rota foi registrada.', 'info');
                    } catch (err) {
                        // erro já exibido em descartarOtimizacao
                    }
                }
            });
        } catch (err) {
            console.error(err);
            falhaGauge();
            Swal.fire('Erro', 'Falha ao comunicar com o otimizador de rotas.', 'error');
        } finally {
            btn.disabled = false;
            btn.innerText = textoOriginal;
        }
    });
});
</script>
{% endblock %}
