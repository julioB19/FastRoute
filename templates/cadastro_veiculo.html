{% extends "htmlBase.html" %}

{% block titulo %}Veículos{% endblock %}

{% block conteudo %}
<div class="container mt-5">
    <div class="card shadow-lg border-0 rounded-4">
        <div class="card-body p-4">
            <h3 class="card-title mb-4 text-center">Gerenciamento de Veículos</h3>
            
            {# Mensagens de Feedback (Sucesso/Erro) #}
            {% if mensagem_sucesso %} 
                <div class="alert alert-success text-center" role="alert">
                    {{ mensagem_sucesso }}
                </div>
            {% endif %}

            {% if erro %} 
                <div class="alert alert-danger text-center" role="alert">
                    {{ erro }}
                </div>
            {% endif %}

            <!-- Formulário de Cadastro e Edição -->
            <div id="form-container">
                <form id="veiculoForm" action="{{ url_for('cadastrar_veiculo') }}" method="POST" class="mt-4">
                    <input type="hidden" id="formAction" name="action" value="cadastrar">
                    <input type="hidden" id="placaHidden" name="placa_original" value="">

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="placaInput" class="form-label">Placa</label>
                            <input type="text" 
                                   class="form-control" 
                                   id="placaInput" 
                                   name="placa" 
                                   required
                                   value="{{ form.placa if form else '' }}">
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="marcaInput" class="form-label">Marca</label>
                            <input type="text" 
                                   class="form-control" 
                                   id="marcaInput" 
                                   name="marca" 
                                   required
                                   value="{{ form.marca if form else '' }}">
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="modeloInput" class="form-label">Modelo</label>
                            <input type="text" 
                                   class="form-control" 
                                   id="modeloInput" 
                                   name="modelo" 
                                   required
                                   value="{{ form.modelo if form else '' }}">
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="tipoCargaSelect" class="form-label">Tipo de Carga</label>
                            <select class="form-select" id="tipoCargaSelect" name="tipo_carga" required>
                                <option value="" selected disabled>Selecione o Tipo de Carga</option>
                                <option value="1" {% if form and form.tipo_carga == '1' %}selected{% endif %}>Normal</option>
                                <option value="2" {% if form and form.tipo_carga == '2' %}selected{% endif %}>Agrotóxico</option>
                            </select>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="limitePesoInput" class="form-label">Limite de Peso (kg)</label>
                            <input type="number" 
                                   step="0.001" 
                                   class="form-control" 
                                   id="limitePesoInput" 
                                   name="limite_peso" 
                                   required
                                   value="{{ form.limite_peso if form else '' }}">
                        </div>
                    </div>

                    <div class="text-center mt-4">
                        <button type="submit" id="submitButton" class="btn px-4" style="background-color: #2f8b4e; color: white;">
                            Salvar
                        </button>
                        <button type="button" id="cancelButton" class="btn btn-secondary px-4" style="display: none;">
                            Cancelar Edição
                        </button>
                    </div> 
                </form>
            </div>

            <hr class="my-5">

            <!-- Tabela de Consulta -->
            <div id="consulta-container">
                <h5 class="mt-4">Lista de Veículos Cadastrados</h5>
                <div class="table-responsive">
                    <table class="table table-striped table-hover mt-3">
                        <thead>
                            <tr>
                                <th>Placa</th>
                                <th>Marca</th>
                                <th>Modelo</th>
                                <th>Tipo de Carga</th>
                                <th>Limite de Peso (kg)</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% if veiculos %}
                                {% for veiculo in veiculos %}
                                <tr data-placa="{{ veiculo.placa }}"
                                    data-marca="{{ veiculo.marca }}"
                                    data-modelo="{{ veiculo.modelo }}"
                                    data-tipo_carga="{{ veiculo.tipo_carga }}"
                                    data-limite_peso="{{ veiculo.limite_peso }}">
                                    <td>{{ veiculo.placa }}</td>
                                    <td>{{ veiculo.marca }}</td>
                                    <td>{{ veiculo.modelo }}</td>
                                    <td>
                                        {% if veiculo.tipo_carga == 1 %} Normal
                                        {% elif veiculo.tipo_carga == 2 %} Agrotóxico
                                        {% else %} ---
                                        {% endif %}
                                    </td>
                                    <td>{{ veiculo.limite_peso }}</td>
                                    <td>
                                        <button class="btn btn-primary btn-sm edit-btn" title="Editar">
                                            <i class="bi bi-pencil-square"></i>
                                        </button>
                                        <form id="form-excluir-{{ veiculo.placa }}" action="{{ url_for('excluir_veiculo', placa=veiculo.placa) }}" method="POST" style="display:inline;">
                                            <button type="button" class="btn btn-danger btn-sm" title="Excluir" onclick="confirmarExclusao('{{ veiculo.placa }}')">
                                                <i class="bi bi-trash-fill"></i>
                                            </button>
                                        </form>
                                    </td>
                                </tr>
                                {% endfor %}
                            {% else %}
                            <tr>
                                <td colspan="6" class="text-center">Nenhum veículo cadastrado.</td>
                            </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('veiculoForm');
    const actionInput = document.getElementById('formAction');
    const placaHiddenInput = document.getElementById('placaHidden');
    const placaInput = document.getElementById('placaInput');
    const submitButton = document.getElementById('submitButton');
    const cancelButton = document.getElementById('cancelButton');

    document.querySelectorAll('.edit-btn').forEach(button => {
        button.addEventListener('click', function() {
            const row = this.closest('tr');
            const placa = row.dataset.placa;
            
            // Preenche o formulário
            placaInput.value = placa;
            document.getElementById('marcaInput').value = row.dataset.marca;
            document.getElementById('modeloInput').value = row.dataset.modelo;
            document.getElementById('tipoCargaSelect').value = row.dataset.tipo_carga;
            document.getElementById('limitePesoInput').value = row.dataset.limite_peso;

            // Altera a ação do formulário para edição
            form.action = "{{ url_for('atualizar_veiculo') }}";
            actionInput.value = 'editar';
            placaHiddenInput.value = placa;
            placaInput.readOnly = true; // Placa não pode ser editada

            // Altera o botão
            submitButton.textContent = 'Atualizar Veículo';
            cancelButton.style.display = 'inline-block';

            // Rola a página para o topo
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });
    });

    cancelButton.addEventListener('click', function() {
        // Limpa o formulário
        form.reset();
        
        // Restaura a ação do formulário para cadastro
        form.action = "{{ url_for('cadastrar_veiculo') }}";
        actionInput.value = 'cadastrar';
        placaHiddenInput.value = '';
        placaInput.readOnly = false;

        // Restaura o botão
        submitButton.textContent = 'Salvar';
        cancelButton.style.display = 'none';
    });
});
</script>
{% endblock %}
